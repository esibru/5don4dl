---
title: Introduction à Elasticsearch

---
import { Card, Aside, Icon, Steps } from '@astrojs/starlight/components';

## 1) Introduction

Nous vous proposons ici une introduction à Elasticsearch, un système stockant des documents JSON (comme MongoDB donc) mais plutôt axé sur la recherche avancée, l'analyse et la visualisation des données.

La documentation officielle d'Elasticsearch mentionne de nombreuses entreprises qui en font usage pour les besoins cités ci-desssus, voyez:  https://www.elastic.co/customers


## 2) Installation d'Elasticsearch

Pour installer Elasticsearch via Docker:


``` bash showLineNumbers=false frame=none
docker run -d --name elasticsearch -p 9200:9200 -e "discovery.type=single-node" -e "xpack.security.enabled=false" docker.elastic.co/elasticsearch/elasticsearch:9.0.1
```

La commande devrait à présent vous semble familière, à l'exception sans doute des deux options 

* `-e "discovery.type=single-node"`
* `-e "xpack.security.enabled=false"`.

La première option sert simplement à demander à ElastiSearch de fonctionner en mode '*standalone*' (une seule instance d'Elasticsearch) plutôt qu'en mode '*cluster*' (plusieurs instances d'Elasticsearch fonctionnant en parallèle).

Utiliser plusieurs instances d'Elasticsearch permet d'augmenter la scalabilité de l'installation (la capacité de stockage/de calcul), nous travaillerons en mode standalone pour le moment (notre but est de découvrir Elasticsearch).

La deuxième option sert à désactiver la sécurité, ce qui sera pratique pour se connecter facilement à Elasticsearch dans un labo de découverte comme celui-ci.

<Aside type="caution" title="Elasticsearch en production">

Dans un environnement de production, ne désactivez évidemment pas la sécurité.
</Aside>

<Aside title="Configuration de la sécurité (optionnel)" icon="setting">
Consultez la documentation officielle d'Elasticsearch pour savoir comment configurer correctement la sécurité et les clusters éventuels, nous ne nous en préocupperons pas dans ce labo d'introduction.
</Aside>

Elasticsearch stocke les documents dans des `index`, l'équivalent d'une collection sous MongoDB.

<Aside type="caution" title="Index sous Elasticsearch">

Ne pas confondre la notion d'index sur un SGBD relationnel (=une structure de donnée permettant d'accélérer les requêtes SQL) et un index sur Elasticsearch (=un conteneur pour les documents JSON).

</Aside>

Elasticsearch fournit essentiellement une API Rest (HTTP) pour communiquer.

Testez donc que le serveur est bien opérationnel au moyen de la commande:

``` bash showLineNumbers=false frame=none
curl http://localhost:9200
```

Le serveur répond normalement vous renvoyant quelques informations (le nom du cluster, notamment). 

Si vous le souhaitez, vous pouvez installer un outil de visualisation des données stockées appelé [Kibana](https://www.elastic.co/downloads/kibana).

## 3) Utiliser Elasticsearch

Pour communiquer avec Elasticsearch nous pouvons au choix:

- lui envoyer directement une requête HTTP (GET, POST, ...).

- utiliser l'interface graphique Kibana (à installer séparément, voir la documention officielle).

- utiliser une librairire cliente lié à un langage et accéder au serveur au moyen de cette librairie.


Essayons donc d'enregistrer un premier document en envoyant une requête `POST` au serveur:

``` bash showLineNumbers=false frame=none
curl -X POST "http://localhost:9200/cours/_doc/1" -H 'Content-Type: application/json' -d '{"ue": "5DON4", "coordinateur": "SDR", "nbEcts": 4}'
```

Cette commande:

- crée un index nommé `cours`,

- ajoute à cet index un document JSON (c'est le `-H 'Content-Type: application/json'`) dont l'identifiant est `1` et dont les données sont précisées après le `-d`.

Pour lire les données et vérifier que le document a été enregistré correctement:

``` bash showLineNumbers=false frame=none
curl http://localhost:9200/cours/_doc/1
```

Comme la communication par l'envoi direct de requêtes HTTP est assez pénible, passons à l'utilisation du client Java. Ajoutez la dépendance suivante:

<Card title="Driver Elasticsearch" icon="seti:maven">
``` xml showLineNumbers=false frame=none
<dependency>
    <groupId>co.elastic.clients</groupId>
    <artifactId>elasticsearch-java</artifactId>
    <version>9.0.1</version>
</dependency>
```
</Card>

<Aside title="Attention" type="caution">
Prenez garde à ce que la version de la dépendance utilisée (9.0.1 ci-dessus) soit la même que la version d'Elasticsearch installée (voir la commande docker). Dans le cas contraire, cela peut donner naissance à des problèmes de communication entre votre application Java et le serveur.
</Aside>

La connection au serveur s'écrit alors comme ceci:


```java
import co.elastic.clients.elasticsearch.ElasticsearchClient;

public static void main(String[] args) {
        String serverUrl = "https://localhost:9200";

        ElasticsearchClient esClient = ElasticsearchClient.of(b -> b.host(serverUrl));

        try{
            esClient.close();
        }catch (Exception e){
		// ...
        }
}
```
 
La librairie comprend une couche de transport (pour l'exécution des requêtes Rest) ainsi que de nombreuses fonctionnalités permettant de parser le JSON (la libraire Jackson est utilisée pour (dé)sérialiser le JSON) et de gérer la sécurité.

Rappelons une fois de plus que la sécurité est un aspect important, mais non présenté dans ce TD (nous nous contentons d'une présentation de l'aspect lié à la gestion de données).

Voyez la documentation officielle pour une explication détaillée de la librairie Java: https://www.elastic.co/docs/reference/elasticsearch/clients/java/usage

Pour lire les données d'un cours d'id donné:

1. Créez un `record` nommé `Cours` au sein de votre code Java et contenant les attributs nécessaires (ue, coordinateur, nbEcts).

2. Utilisez le code suivant:

```java
GetResponse<Cours> getResponse = esClient.get(g -> g
                            .index("cours")
                            .id("1"),
                   Cours.class
            );
if (getResponse.found()) {
     Cours cours = getResponse.source();
     System.out.println("Le cours d'id 1 est: " + cours.ue());
     System.out.println("Le coordinateur est : " + cours.coordinateur());
}
```



<Card title="Ajoutez de nouveaux documents" icon="pencil">
Ajoutez de nouveaux cours de l'ESI à votre index `cours` à partir de votre code Java. Faites une recherche dans la documentation d'Elasticsearch (avec les mots clés `Indexing single documents`) pour savoir comment procéder.
</Card>

Ajoutez au moins une dizaine de cours (ceci nous permettra de tester les fonctionnalités de recherche à la section suivante).

## 4) Rechercher des documents

Avec tout cela, nous n'avons pas encore abordé les fonctionnalités de recherche d'Elasticsearch. Il est par exemple possible de chercher des documents:

- contenant exactement une certain valeur (méthode `match`). Par exemple, rechercher l'UE nommée  `5DON4`.

- contenant une sous-chaîne de caractère (méthode `wildcard`). C'est l'équivalent du `LIKE` en SQL.

- satisfaisant une certaine expression régulière (méthode `regexp`).

- satisfaisant une combinaison des conditions ci-dessus (méthode `bool`).

Par exemple, pour chercher toutes les UE de `DON` de l'ESI nous pourrions écrire:

```java
SearchResponse<Cours> search = esClient.search(s -> s
        .index("cours")
        .query(q -> q
            .wildcard(w -> w
                .field("ue")   
                .value("*DON*")        // * = n’importe quelle séquence de caractères
            )
        ),
    Cours.class
);

for (Hit<Cours> hit : search.hits().hits()) {
            System.out.println("Cours: " + hit.source().ue);
}

```

<Card title="Rechercher" icon="pencil">
Utilisez la documentation d'Elasticsearch pour écrire une application Java permettant d'effectuer diverses chercher sur les cours de l'ESI selon divers critères, par exemple:
- Trouver tous les cours d'un certain bloc,
- Trouver tous les cours de DON ou de DEV,
- Trouver tous les cours de DON donné en Bloc2.
- ...
</Card>

## 5) Recherche avancée

Venons en à présent à une des vraies forces d'ElasticSearch: les options de recherches avancées, et en particulier les **recherches floues (fuzzy search)**.

L'idée est qu'ElasticSearch est capable de retrouver un document contenant une certaine valeur même si la valeur précisée pour la recherche contient une faute de frappe.

**Exemple**: Vous lancez une recherche permettant de retrouver les cours de base de données sur base du mot clé `DOM` (au lieu de `DON`). ElasticSearch  retrouve tout de même les cours de `DON`.

Comment ElasticSearch procède-t-il pour ce faire ? Il utilise simplement la **distance de Levenshtein** entre deux chaînes de caractères pour savoir si deux chaînes de caractères différentes sont "proches" l'une de l'autre ou pas.

La distance de Levenshtein `lev(s,t)` entre deux chaînes de caractères `s` et `t` est définie comme le nombre minimum de suppression,insertion,substitution de lettres nécessaire pour passer de `s` à `t`.

Par exemple:

`lev(DOM,DON) = lev(5DON,DON) = lev(DO,DON) = 1`

vu que, dans chacun de ces trois cas, on peut passer d'une chaîne à l'autre au moyen d'une seule substitution (premier cas),insertion (deuxième cas),suppression (troisième cas) de lettre.

Pour plus d'information sur la distance de Levenshtein (et notamment une formulation récursive de `lev`) voyez par exemple: https://en.wikipedia.org/wiki/Levenshtein_distance:

<Card title="Distance de Levenshtein" icon="pencil">
Ecrivez en Java (ou dans votre langage de programmation favori) une méthode récursive calculant la distance de Levenshtein de deux chaînes de caractères reçues en paramètre.
</Card>

A présent, pour demander à ElasticSearch de prendre en compte des chaînes de caractères situées à une certaine distance dans sa recherche:

```java
// Remplacez le '1' par la valeur souhaitée
String distance = "1"
SearchResponse<Cours> search = esClient.search(s -> s
                        .index("cours")
                        .query(q -> q
                                .fuzzy(f -> f
                                        .field("ue")
                                        .value("DOM") 	// faute volontaire
                                        .fuzziness(distance)     
                                )
                        ),
                Cours.class
        );
```

On peut aussi laisser ElasticSearch choisir une distance qui convient en fonction de la longueur de la chaîne (au plus la chaîne est longue, au plus la distance choisie sera grande) en précistant:

```java
.fuzziness("AUTO") 
```

<Card title="Rechercher" icon="pencil">
Modifiez votre application Java permettant d'effectuer des recherches sur les cours de l'ESI. L'application devra permettre d'effectuer une recherche sur base de l'acronyme du coordinateur (SDR, SRE, PBT, ...) ou de l'UE (5DON4, ...) en acceptant une certaine tolérance sur les entrées de l'utilisateur.
</Card>

ElasticSearch fournit des outils de recherche encore plus avancés, notamment:

- le **stemming**: réduire un mot à sa racine de façon inclure les variantes d'un mot dans une recherche. Ceci dépend généralement de la langue. Par exemple, en français, on peut souhaiter qu'une recherche avec le mot clé `analyser` fournisse aussi les documents faisant intervenir les mots `analyse`, `analyses`, `analytique`, etc.

- la recherche sur base de synonymes. On peut définir des synonymes au sein d'un index ElasticSearch, de sorte qu'un recherche sur l'un des mots fournisse aussi les résultats faisant intervenir les synonymes.

Voyez la documentation officielle ElasticSearch pour plus de détails sur ces fonctionnalités avancées.
