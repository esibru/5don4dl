---
title: Solutions à introduction à Neo4J (base de données orientée graphes)
description: Description du premier laboratoire
---

import { Card, Aside, Icon, Steps } from '@astrojs/starlight/components';

## Créer une db postgres avec docker

<Steps>
1. Ajouter un dockerfile avec le contenu suivant (adapté avec vos données).
   ``` text showLineNumbers=false title=Dockerfile
   FROM postgres:16
   
   ENV POSTGRES_USER=g12345
   ENV POSTGRES_PASSWORD=admin
   ENV POSTGRES_DB=mproject
   ```
1. Créer une image

   ``` text showLineNumbers=false frame=none
   docker build -t mypostgres .
   ```

1. Créer un conteneur

   ``` text showLineNumbers=false frame=none
   docker run --name mypostgres -p 5433:5432 -d mypostgres
   ```
   (`--name` permet de nommer le conteneur)

</Steps>

<Aside title="Docker - psql" icon="seti:docker">
Vous pouvez accéder au terminal interactif de postgres [psql](https://docs.postgresql.fr/13/app-psql.html) grâce à la commande

   ``` bash showLineNumbers=false frame=none
   docker exec -it mypostgres psql -U g12345 -d mproject
   ```
Et dès lors,
* lister les tables existantes :
   ``` sql showLineNumbers=false frame=none
   \dt
   ```
* décrire une  table :
   ``` sql showLineNumbers=false frame=none
   \d ville
   ```
  
* faire toutes les requêtes utiles (en n'oubliant pas le `;`)
   Ex : 
   ``` sql showLineNumbers=false frame=none
   SELECT * FROM ville;
   ``` 
* ...
</Aside>

## Création des tables

``` SQL
-- Suppression si existant (utile pour relancer le script)
DROP TABLE IF EXISTS troncon;
DROP TABLE IF EXISTS ville;

-- Table ville
CREATE TABLE ville (
    idville      INT PRIMARY KEY,
    nom          VARCHAR(100) NOT NULL,
    pays         VARCHAR(100) NOT NULL,
    CONSTRAINT uq_ville UNIQUE (nom, pays)
);

-- Table troncon
CREATE TABLE troncon (
    idtroncon    INT PRIMARY KEY,
    villeDepart  INT NOT NULL,
    villeArrivee INT NOT NULL,
    longueurKm   DECIMAL(6,2) NOT NULL CHECK (longueurKm > 0),
    
    CONSTRAINT fk_depart FOREIGN KEY (villeDepart) REFERENCES ville(idville),
    CONSTRAINT fk_arrivee FOREIGN KEY (villeArrivee) REFERENCES ville(idville),
    CONSTRAINT chk_diff CHECK (villeDepart <> villeArrivee),
    CONSTRAINT uq_troncon UNIQUE (villeDepart, villeArrivee)
);
```

## Population des tables 

``` SQL
-- villes
INSERT INTO ville (idville, nom, pays) VALUES
(1, 'Bruxelles', 'Belgique'),
(2, 'Paris', 'France'),
(3, 'Lille', 'France'),
(4, 'Amsterdam', 'Pays-Bas'),
(5, 'Cologne', 'Allemagne'),
(6, 'Lyon', 'France'),
(7, 'Francfort', 'Allemagne');

-- Tronçons
INSERT INTO troncon (idtroncon, villeDepart, villeArrivee, longueurKm) VALUES
(1, 1, 2, 310.0),  -- Bruxelles -> Paris
(2, 1, 3, 110.0),  -- Bruxelles -> Lille
(3, 1, 4, 200.0),  -- Bruxelles -> Amsterdam
(4, 3, 2, 220.0),  -- Lille -> Paris
(5, 3, 5, 300.0),  -- Lille -> Cologne
(6, 4, 5, 270.0),  -- Amsterdam -> Cologne
(7, 2, 6, 460.0),  -- Paris -> Lyon
(8, 2, 5, 500.0),  -- Paris -> Cologne
(9, 5, 1, 220.0),  -- Cologne -> Bruxelles
(10, 5, 7, 190.0); -- Cologne -> Francfort
```

## Atteignabilité 1 tronçon

```SQL
SELECT DISTINCT v2.nom, v2.pays
FROM ville v1
JOIN troncon t ON v1.idville = t.villeDepart
JOIN ville v2 ON t.villeArrivee = v2.idville
WHERE v1.nom = 'Bruxelles';
```

## Atteignabilité 2 tronçons

```SQL
SELECT DISTINCT v2.nom, v2.pays
FROM ville v1
JOIN troncon t1 ON v1.idville = t1.villeDepart
JOIN troncon t2 ON t1.villeArrivee = t2.villeDepart
JOIN ville v2 ON t2.villeArrivee = v2.idville
WHERE v1.nom = 'Bruxelles';
```
## Atteignabilité 3 tronçons

```SQL
SELECT DISTINCT v2.nom, v2.pays
FROM ville v1
JOIN troncon t1 ON v1.idville = t1.villeDepart
JOIN troncon t2 ON t1.villeArrivee = t2.villeDepart
JOIN troncon t3 ON t2.villeArrivee = t3.villeDepart
JOIN ville v2 ON t3.villeArrivee = v2.idville
WHERE v1.nom = 'Bruxelles';
```
## Atteignabilité n tronçons

```SQL
WITH RECURSIVE chemins AS (
    -- Point de départ : Bruxelles
    SELECT v.idville, v.nom, v.pays
    FROM ville v
    WHERE v.nom = 'Bruxelles'
    
    UNION
    
    -- Extension du chemin : on ajoute un tronçon à chaque étape
    SELECT v2.idville, v2.nom, v2.pays
    FROM chemins c
    JOIN troncon t ON c.idville = t.villeDepart
    JOIN ville v2 ON t.villeArrivee = v2.idville
)

SELECT DISTINCT nom, pays
FROM chemins
WHERE nom <> 'Bruxelles';
```
